var fixDate = function(dateIn) {
  var dat = new Date(dateIn);
  return Date.UTC(dat.getFullYear(), dat.getMonth(), dat.getDate());
};

var getOHLC = function(json) {
  console.log("JSON IS " + json)

  var dates = json.Dates || [];
  var elements = json.Elements || [];
  var chartSeries = [];

  if (elements[0]){

    for (var i = 0, datLen = dates.length; i < datLen; i++) {
      var dat = fixDate( dates[i] );
      var pointData = [
        dat,
        elements[0].DataSeries['open'].values[i],
        elements[0].DataSeries['high'].values[i],
        elements[0].DataSeries['low'].values[i],
        elements[0].DataSeries['close'].values[i]
      ];
      chartSeries.push( pointData );
    };
  }
  return chartSeries;
};


var groupingUnits = [[
  'week',                         // unit name
  [1]                             // allowed multiples
], [
  'month',
  [1, 2, 3, 4, 6]
]];

$('#stocksContainer').highcharts('StockChart', {

  rangeSelector: {
    selected: 1
  },

  title: {
    text: '<%= @symbol %>' + ' Historical Price'
  },

  yAxis: [{
    title: {
      text: 'OHLC'
    },
    height: 200,
    lineWidth: 2
  }],

  series: [{
    type: 'candlestick',
    name: '<%= @symbol %>',
    data: getOHLC(<%= @stock_data %>),
      dataGrouping: {
        units: groupingUnits
      }
  }],

  credits: {
    enabled:false
  }
});
